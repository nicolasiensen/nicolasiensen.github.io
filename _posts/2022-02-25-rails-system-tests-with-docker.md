---
layout: post
title:  "Running Rails' system tests with Docker"
share-description: This tutorial explains how to run Rails' system tests using a Docker container.
tags: ruby rails docker tutorial system-testing
---

Rails supports many different types of automated tests to give developers a safety net to prevent breaking existing behavior when enacting changes to the project.

The [Rails Guides website](https://guides.rubyonrails.org/testing.html) provides detailed documentation of all types of automated tests supported by the framework.

[System testing](https://guides.rubyonrails.org/testing.html#system-testing) is one of the options we have to cover our codebase with automated testing. System tests exercise the Rails application from the end-user perspective using a web browser. Together with other tests, we can use system testing to automate most of the quality assurance of a product, if not its entirety.

In his excellent blog post ["Rails 6 System Tests, from Top to Bottom"](https://avdi.codes/rails-6-system-tests-from-top-to-bottom/), [Avdi Grimm](https://twitter.com/avdi) unravels all the components involved in a system test and how they collaborate to test Rails applications from end-to-end.

The list below attempts to summarize the blog post mentioned above, but reading the original text is highly recommended:

- [MiniTest](https://github.com/seattlerb/minitest): the default test framework shipped in Rails.
- [Capybara](https://github.com/teamcapybara/capybara): a Ruby gem that can start and stop the Rails application under test and provides an interface to interact with the browser.
- [selenium-webdriver](https://rubygems.org/gems/selenium-webdriver/versions/2.53.4): a Ruby gem that provides a lower-level interface, compared to Capybara's, to interact with the browser.
- [WebDriver](https://www.selenium.dev/documentation/webdriver/): a software program that interacts with a browser. Each browser has its own WebDriver implementation, like [ChromeDriver](https://chromedriver.chromium.org/), [GeckoDriver (for Firefox)](https://firefox-source-docs.mozilla.org/testing/geckodriver/) and others. Rails includes a gem called "webdrivers" which installs the WebDrivers in the host machine.
- The web browser: Chrome, Firefox, and others.

Running system tests from a containerized Rails application is not straightforward since, most likely, the Docker image used to run the Rails application won't have a web browser installed to execute the system test.

We won't cover the containerization of a Rails application in this tutorial.

In this tutorial, we will walk through creating a Docker-friendly setup to run Rails' system tests.

[In the previous blog post](https://nicolasiensen.github.io/2022-02-01-creating-a-new-rails-application-with-docker/) we generated a new Rails application using Docker, and we will use that as a basis to get a Rails application up and running in a Docker container.

```yaml
services:
  web:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - .:/usr/src/app
    command: rails s -b 0.0.0.0
```

## Step 1: Prepare the Rails application for testing

We will use Rails' scaffold generator to bootstrap the [CRUD](https://en.wikipedia.org/wiki/Create,_read,_update_and_delete) features to create, view, update and delete posts together with its respective system tests:

```
bin/rails g scaffold post title:string body:text published:boolean
```

Once the code is generated, we can migrate the database:

```
bin/rails db:migrate
```

We can now try to run the system tests generated by Rails:

```
bin/rails test:system
```

The output is an error message saying `Failed to find Chrome binary. (Webdrivers::BrowserNotFound)`. This error message was raised by the gem `webdrivers` which couldn't find Chrome installed in the container.

## Step 2: Exclude the gem `webdrivers` from the project's dependencies

Since we will install Chrome and its respective WebDriver in a separate container, we don't need the gem `webdrivers` listed in the project's dependencies:

```ruby
# Remove the line below from the Gemfile
gem "webdrivers"
```

After removing the dependency and rebuilding the Docker container, we can try to run the system tests again:

```
bin/rails test:system
```

The output this time will have a different error saying `Unable to find chromedriver. Please download the server from...`.

## Step 3: Point selenium-webdriver to a remote server

By default, `selenium-webdriver` will try to connect to a WebDriver in *localhost*, let's change that to point it to a remote address:

```ruby
# test/application_system_test_case.rb
driven_by :selenium, using: :chrome, screen_size: [1400, 1400], options: {
  browser: :remote,
  url: "http://chrome-server:4444"
}
```

The host `chrome-server:4444` doesn't exist yet, but this will be the address where we will make the Chrome WebDriver available for our tests.

Let's try to run the system tests again:

```
bin/rails test:system
```

Once more we get an error, but this time it says `Failed to open TCP connection to chrome-server:4444 (getaddrinfo: Name or service not known)`, progress!

---

```
services:
  web:
    build: .
    ports:
      - "3000:3000"
    volumes:
      - .:/usr/src/app
    command: rails s -b 0.0.0.0
    links:
      - chrome-server
  chrome-server:
    image: selenium/standalone-chrome:96.0
```

```
Selenium::WebDriver::Error::UnknownError: unknown error: net::ERR_CONNECTION_REFUSED
```

---

```
Capybara.server_host = "0.0.0.0"
Capybara.app_host = "http://#{ENV.fetch("HOSTNAME")}:#{Capybara.server_port}"
```
